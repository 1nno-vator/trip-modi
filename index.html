<!DOCTYPE html>
<html>
    <head>
        <script src="https://d3js.org/d3-dispatch.v2.min.js"></script>
        <script src="https://d3js.org/d3-selection.v2.min.js"></script>
        <script src="https://d3js.org/d3-drag.v2.min.js"></script>
        <script src="https://d3js.org/d3.v6.js"></script>

        <style>
            .active {
                fill: red
            }
        </style>

        <script>
            document.addEventListener("DOMContentLoaded", function(){
            // Handler when the DOM is fully loaded

            console.log('hihi');


            const alldata = async () => {
                const data = await d3.tsv("https://gist.githubusercontent.com/mbostock/5544008/raw/446592acc3a9223ad268c7b051a68b814e40789c/schedule.tsv");
                
                // Extract the stations from the "stop|*" columns.
                const stations = data.columns
                    .filter(key => /^stop\|/.test(key))
                    .map(key => {
                    const [, name, distance, zone] = key.split("|");
                    return {key, name, distance: +distance, zone: +zone};
                    });

                const returnObj = Object.assign(
                    data.map(d => ({
                    number: d.number,
                    type: d.type,
                    direction: d.direction,
                    stops: stations
                        .map(station => ({station, time: parseTime(d[station.key])}))
                        .filter(station => station.time !== null)
                    })),
                    {stations}
                );

                console.log(stations);
                console.log(returnObj);
                drawChart(returnObj)
            };

            console.log(d3.drag());

            alldata();

            // drawSample();

        });

        function drawSample() {
            var width = 500;
            var height = 500;

            //Create SVG element
            var svg = d3.select("body")
            .append("svg")
            .attr("width", width)
            .attr("height", height);

            //Create and append line
            svg.append("line")
                    .attr("x1", 100)
                    .attr("x2", 500)
                    .attr("y1", 50)
                    .attr("y2", 250)
                    .attr("stroke", "black")
        }


        function drawChart(alldata) {
            
            console.log(d3);
            console.log(alldata);

            const data = alldata;
            // const data = alldata.filter(d => days(d) && direction(d));
            const stations = alldata.stations;
            const stops = d3.merge(data.map(d => d.stops.map(s => ({train: d, stop: s}))));

            const width = 1600;
            const height = 2400;
            const margin = ({top: 120, right: 30, bottom: 120, left: 50});

            const colors = ({
                N: "rgb(34, 34, 34)",
                L: "rgb(183, 116, 9)",
                B: "rgb(192, 62, 29)",
                W: "currentColor",
                S: "currentColor"
            })

            const x = d3.scaleLinear()
                        .domain(d3.extent(stations, d => d.distance))
                        .range([margin.left + 10, width - margin.right]);
            
            const y = d3.scaleUtc()
                        .domain([parseTime("4:30AM"), parseTime("1:30AM")])
                        .range([margin.top, height - margin.bottom]);

            const line = d3.line()
                        .x(d => x(d.station.distance))
                        .y(d => y(d.time));

            let voronoi = d3.Delaunay
                        .from(stops, d => x(d.stop.station.distance), d => y(d.stop.time))
                        .voronoi([0, 0, width, height]);

            const xAxis = g => g
                            .style("font", "10px sans-serif")
                        .selectAll("g")
                        .data(stations)
                        .join("g")
                            .attr("transform", d => `translate(${x(d.distance)},0)`)
                            .call(g => g.append("line")
                                .attr("y1", margin.top - 6)
                                .attr("y2", margin.top)
                                .attr("stroke", "currentColor"))
                            .call(g => g.append("line")
                                .attr("y1", height - margin.bottom + 6)
                                .attr("y2", height - margin.bottom)
                                .attr("stroke", "currentColor"))
                            .call(g => g.append("line")
                                .attr("y1", margin.top)
                                .attr("y2", height - margin.bottom)
                                .attr("stroke-opacity", 0.2)
                                .attr("stroke-dasharray", "1.5,2")
                                .attr("stroke", "currentColor"))
                            .call(g => g.append("text")
                                .attr("transform", `translate(0,${margin.top}) rotate(-90)`)
                                .attr("x", 12)
                                .attr("dy", "0.35em")
                                .text(d => d.name))
                            .call(g => g.append("text")
                                .attr("text-anchor", "end")
                                .attr("transform", `translate(0,${height - margin.top}) rotate(-90)`)
                                .attr("x", -12)
                                .attr("dy", "0.35em")
                                .text(d => d.name));
            
            const yAxis = g => g
                                .attr("transform", `translate(${margin.left},0)`)
                                .call(d3.axisLeft(y)
                                    .ticks(d3.utcHour)
                                    .tickFormat(d3.utcFormat("%-I %p")))
                                .call(g => g.select(".domain").remove())
                                .call(g => g.selectAll(".tick line").clone().lower()
                                    .attr("stroke-opacity", 0.2)
                                    .attr("x2", width));

            const tooltipF = g => {
                                    const formatTime = d3.utcFormat("%-I:%M %p");
                                
                                    const tooltip = g.append("g")
                                        .style("font", "10px sans-serif");
                                
                                    const path = tooltip.append("path")
                                        .attr("fill", "white");
                                
                                    const text = tooltip.append("text");
                                
                                    const line1 = text.append("tspan")
                                        .attr("x", 0)
                                        .attr("y", 0)
                                        .style("font-weight", "bold");
                                
                                    const line2 = text.append("tspan")
                                        .attr("x", 0)
                                        .attr("y", "1.1em");
                                
                                    const line3 = text.append("tspan")
                                        .attr("x", 0)
                                        .attr("y", "2.2em");
                                
                                    g.append("g")
                                        .attr("fill", "none")
                                        .attr("pointer-events", "all")
                                    .selectAll("path")
                                    .data(stops)
                                    .join("path")
                                        .attr("d", (d, i) => voronoi.renderCell(i))
                                        .on("mouseout", () => tooltip.style("display", "none"))
                                        .on("mouseover", (ev, d) => {
                                            tooltip.style("display", null);
                                            line1.text(`${d.train.number}${d.train.direction}`);
                                            line2.text(d.stop.station.name);
                                            line3.text(formatTime(d.stop.time));
                                            path.attr("stroke", colors[d.train.type]);
                                            const box = text.node().getBBox();
                                            path.attr("d", `
                                                M${box.x - 10},${box.y - 10}
                                                H${box.width / 2 - 5}l5,-5l5,5
                                                H${box.width + 10}
                                                v${box.height + 20}
                                                h-${box.width + 20}
                                                z
                                        `);
                                        tooltip.attr("transform", `translate(${
                                            x(d.stop.station.distance) - box.width / 2},${
                                            y(d.stop.time) + 28
                                        })`);
                                        })
                                    ;
                                };
            
            

            const svg = d3.select("body")
                        .append("svg")
                        .attr("width", width)
                        .attr("height", height);
        
            svg.append("g")
                .call(xAxis);
        
            svg.append("g")
                .call(yAxis);
        
            const train = svg.append("g")
                .attr("stroke-width", 5)
            .selectAll("g")
            .data(data)
            .join("g")
        
            let path = train.append("path")
                .attr("fill", "none")
                .attr("stroke", d => colors[d.type])
                // .attr("stroke", "blue")
                .attr("d", d => line(d.stops))
                ;
        
            train.append("g")
                .attr("stroke", "white")
                .attr("fill", d => colors[d.type])
            .selectAll("circle")
            .data(d => d.stops)
            .join("circle")
                .attr("transform", d => `translate(${x(d.station.distance)},${y(d.time)})`)
                .attr("r", 5)
                ;
        
            svg.append("g")
                 .call(tooltipF);

            const svgnode = svg.node();

            console.log(svgnode);

            const container = d3.select('svgContiner')
                                .append(svgnode);
            console.log(container);

            function update() {
                voronoi = d3.Delaunay.from(path, d => d.x, d => d.y).voronoi([0, 0, width, height]);
                path.attr("transform", d => `translate(${d.x},${d.y})`);
            }

        }

        const parseTime = (string) => {
            const parseTime = d3.utcParse("%I:%M%p");
            
            const date = parseTime(string);
            if (date !== null && date.getUTCHours() < 3) {
                date.setUTCDate(date.getUTCDate() + 1);
            }

            return date;
            
        }

        function dragstarted(d) {
        d3.select(this).raise().classed("active", true);
        }

        function dragged(event, d) {
            
            const ou = d3.select(this);
        
            console.log(ou.select("path"));

            ou.select("path").remove();
        }

        function dragended(d) {
        d3.select(this).classed("active", false);
        }

        </script>
    </head>
    <body>
        <div id='svgContiner'></div>
    </body>
</html>